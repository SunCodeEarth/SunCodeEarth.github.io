var parseDate=d3.time.format("%Y-%m-%d").parse,formatDate=d3.time.format("%x"),width=1e3,height=600,projection=d3.geo.eckert4().scale(180).translate([width/2,height/2]).precision(.1),color=d3.scale.log().domain([1e4,16257463248]).range(["orange","purple"]).clamp(!0).interpolate(d3.interpolateHcl),linkWidth=d3.scale.log().domain([1e9,16257463248]).range([2,50]).clamp(!0),path=d3.geo.path().projection(projection),svg=d3.select("#GeogMap").append("svg").attr("width",width).attr("height",height);svg.append("defs").append("path").datum({type:"Sphere"}).attr("id","sphere").attr("d",path),svg.append("use").attr("class","stroke").attr("xlink:href","#sphere"),svg.append("use").attr("class","fill").attr("xlink:href","#sphere");var lPt=projection([-180,0]),rPt=projection([180,0]),tPt=projection([0,90]),bPt=projection([0,-90]),cW=rPt[0]-lPt[0],cH=bPt[1]-tPt[1],canvas=d3.select("#CanvasMap").append("canvas").attr("width",cW).attr("height",cH);d3.select("#CanvasMap").style("width",cW+"px").style("height",cH+"px").style("left",lPt[0]+200+"px").style("top",tPt[1]+"px");var context=canvas.node().getContext("2d");function getImage(t,e){var n=new Image;n.onload=function(){e(n)},n.src=t}getImage("N1.png",(function(t){context.drawImage(t,0,0,cW,cH),t=context.getImageData(0,0,cW,cH);for(var e=0,n=cW*cH*4,a=t.data;e<n;e+=4)a[e+0]<8&&a[e+1]<8&&a[e+2]<8?a[e+3]=0:a[e+3]=220;context.putImageData(t,0,0)}));var numB=d3.format(",.2gr");function ready(t,e,n,a){var r=d3.nest().key((function(t){return t.id})).sortValues((function(t,e){return t.TOTAL_EXCESS_KG-e.TOTAL_EXCESS_KG})).map(a,d3.map),i=svg.insert("g",".graticule").attr("class","land").selectAll("path").data(topojson.feature(e,e.objects.countries).features).enter().append("path").attr("d",path);i.on("mouseenter",(function(t){i.filter((function(e){return e.id===t.id})).style("fill","green"),updateTextPanel(t,r,l,s,u)})).on("click",(function(t){})).on("mouseleave",(function(t){i.filter((function(e){return e.id===t.id})).style("fill","none")})),i.filter((function(t){return r.has(t.id)})).append("title").text((function(t){var e=r.get(t.id);return e[0].NAME+"\n"+e.map((function(t){return""+transformWeightValue(t.TOTAL_EXCESS_KG,numB)})).join("\n")})),svg.insert("path",".graticule").datum(topojson.mesh(e,e.objects.countries,(function(t,e){return t!==e}))).attr("class","boundary").attr("d",path);var o=d3.select("#LinkedGeogTreeMaps").append("svg").attr("class","links").attr("top",0).attr("left",0).attr("width",1200).attr("height",800),l=o.append("text").attr("class","countryText").attr("x",(function(t){return"270px"})).attr("y",(function(t){return"273px"})).attr("dx",(function(t){return"0px"})).attr("dy",(function(t){return"0px"})).style("text-anchor","start").style("font-size","16px").text("Global Excess Nitrogen").attr("dominant-baseline","middle").attr("alignment-baseline","middle"),s=o.append("text").attr("class","countryText").attr("x",(function(t){return"270px"})).attr("y",(function(t){return"288px"})).attr("dx",(function(t){return"0px"})).attr("dy",(function(t){return"0px"})).style("text-anchor","start").attr("dominant-baseline","middle").attr("alignment-baseline","middle"),u=o.append("text").attr("class","countryText").attr("x",(function(t){return"270px"})).attr("y",(function(t){return"300px"})).attr("dx",(function(t){return"0px"})).attr("dy",(function(t){return"0px"})).style("text-anchor","start").attr("dominant-baseline","middle").attr("alignment-baseline","middle"),d=plotExcessNBoxes("#SankeyBox",190,800,100,2,n,l,s,u,i),c=d3.nest().key((function(t){return t.SUBREGION})).entries(a),p={name:"excessN",children:[]};c.forEach((function(t){var e={name:t.key,children:[]};t.values.forEach((function(t){e.children.push(t)})),p.children.push(e)})),topojson.feature(e,e.objects.countries).features.forEach((function(t){var e=d.filter((function(e){return e.id===t.id}));if(e&&e.length>0){var n,a=path.bounds(t),r=Math.round(.5*(a[0][0]+a[1][0])+200),i=Math.round(a[1][1]),l=Math.round(e[0].left+e[0].width/2),s=Math.round(e[0].top+e[0].height),u="",c=0,p=e[0].WebVis;"China"==e[0].name?(r+=30,i-=20,c=Math.round(.5*(r+l))):"India"==e[0].name?(r-=12,i-=32,c=Math.round(.5*(r+l))):"United States"==e[0].name?(r-=222,i-=46,c=Math.round(.5*(r+l))):"Africa"==e[0].name&&(i-=40,c=Math.round(.5*(r+l))),u=(u=u+" M "+l+" "+s+" C "+l+" "+(n=(i+=Math.round(1.2*e[0].width))+p.linkPosY)+" "+l+" "+n+" "+c+" "+n)+" M "+c+" "+n+" C "+r+" "+n+" "+r+" "+n+" "+r+" "+i,"Rest of the World"==e[0].name&&(u=" M "+l+" "+s+" L "+1*l+" "+(s+188)),o.append("path").attr("class","link").attr("id","Path_R"+e[0].id).attr("d",u).style("stroke-width",(function(t){return e[0].width}));var f=Math.round(1.2*e[0].width),h="";"Rest of the World"==e[0].name?h="":(h="M "+(r-f)+" "+i+" L "+r+" "+(i-Math.round(1.2*f))+" L "+(r+f)+" "+i+" Z",o.append("path").attr("class","link").attr("d",h).style("fill","#080").style("fill-opacity",.5)),o.append("text").style("font-size","12px").style("font-family","Avenir,Verdana,Arial,Times New Roman").attr("stroke","brown").style("background-color","white").append("textPath").attr("textLength",(function(){return 7*(4+e[0].name.length)})).attr("startOffset",p.textOffset).style("baseline-shift",Math.round(.65*e[0].width)).attr("dy","1.6em").attr("dx","-1.5em").attr("xlink:href","#Path_R"+e[0].id).text((function(){return e[0].name+" "+e[0].value+"%"}))}}))}function type(t){return t.id=+t.ISO_N3,t.TOTAL_EXCESS_KG=+t.TOTAL_EXCESS_KG,t}function updateTextPanel(t,e,n,a,r){null!=t&&"undefined"!=t.id&&null!=e.get(t.id)&&"undefined"!=e.get(t.id)&&(n.text((function(){return e.get(t.id)[0].NAME})),a.text((function(){return"Excess Nitrogen: "+transformWeightValue(e.get(t.id)[0].TOTAL_EXCESS_KG,numB)})),r.text((function(){var n=e.get(t.id)[0];return"Global Percentage: "+d3.round(n.TOTAL_EXCESS_KG/49592471724*100,2)+"%"})))}function transformWeightValue(t,e){return t<100?e(t)+" KG":t<1e5?e(t/1e3)+" TONNES":t<1e8?e(t/1e6)+" K TONNES":e(t/1e9)+" Million TONNES"}function updateTextPanelBox(t,e,n,a,r,i){"i"!=n&&"input"!=n&&"inputs"!=n||(a.text("Nitrogen Input"),r.text("Source: "+t),i.text("Percentage: "+e+"%")),"o"!=n&&"output"!=n&&"outputs"!=n||(a.text("Nitrogen Output"),r.text("Destination: "+t),i.text("Percentage: "+e+"%")),"r"!=n&&"region"!=n&&"regions"!=n||(a.text("Excess Nitrogen"),r.text("Destination: "+t),i.text("Percentage: "+e+"%"))}function plotExcessNBoxes(t,e,n,a,r,o,l,s,u,d){var c=t,p=Math.round(.1*n),f=Math.round(.1*n),h=d3.select(c).append("svg").attr("width",e).attr("height",n).attr("class","ExcessNBox"),x=o.entries[0].Inputs,g=h.selectAll("rect").data(x).enter();g.append("svg:rect").attr("x",(function(t,n){return t.left=0==n?r:x[n-1].left+Math.round(x[n-1].value/100*e),t.left})).attr("y",(function(t,e){return a})).attr("width",(function(t,n){return Math.round(t.value/100*e)})).attr("height",(function(t,e){return p})).style("fill","#88a").on("mouseenter",(function(t){d3.select(this).style("opacity",.3),updateTextPanelBox(t.name,t.value,"i",l,s,u)})).on("mouseleave",(function(t){d3.select(this).style("opacity",1),d.filter((function(e){return e.id===t.id})).style("fill","none")})),g.append("svg:text").attr("x",(function(t){return t.left+4})).attr("y",a+50).style("fill","maroon").style("font-size","10px").text((function(t){return t.name}));var y=.5*(r+e),m=" M "+(y-10)+" "+a+" L "+y+" "+(a+10)+" L "+(y+10)+" "+a+" Z";h.append("svg:path").attr("d",m).style("fill","black"),h.append("svg:text").attr("x",r+50).attr("y",a+20).style("fill","black").style("font-size","10px").text("Global Nitrogen Inputs");var v,M,T,E=o.entries[1].Outputs[0],w=Math.round(E.value/100*e),b=new Array,N=200/90,k=Math.round(.03*n);for(i=0;i<90;i++)M=(v=r+Math.round(i*N))+Math.round(N*Math.random()),T=a+p+10+Math.round(Math.random()*k/1.3),b.push([v,M,T]);b.forEach((function(t,e){h.append("svg:path").attr("class","grassVis").attr("fill-opacity",.2*Math.random()).style("fill","green").style("stroke-opacity",0).attr("d",(function(e,n){var r="M "+t[0]+" "+(a+p+k)+" T "+t[1]+" "+t[2];return r=r+" T "+(t[0]+Math.round(N))+" "+(a+p+k)+" Z"})).transition().duration(8e3).ease("linear").attr("fill-opacity",1).attr("d",(function(){T=a+p+10+Math.round(Math.random()*k/3),t[2]=T;var e="M "+t[0]+" "+(a+p+k)+" T "+t[1]+" "+t[2];return e=e+" T "+(t[0]+Math.round(N))+" "+(a+p+k)+" Z"}))}));var P=!1,S=d3.selectAll(".grassVis").datum(b);setInterval((function(){S.transition().duration(8e3).attr("fill-opacity",(function(){return P?1:.5*Math.random()})).attr("d",(function(t,e){var n=a+p-k+10;n+=P?Math.round(.333*Math.random()*k):Math.round(.6*(.5+.5*Math.random())*k);var r=t[e],i=4*Math.random()*(P?1:-1),o="M "+r[0]+" "+(a+p+0)+" T "+(i+r[1])+" "+n;return o=o+" T "+(r[0]+Math.round(N))+" "+(a+p+0)+" Z"})),P=!P}),1e4),p+=.03*n,h.append("svg:rect").attr("x",r).attr("y",a+p).attr("width",Math.round(E.value/100*e)).attr("height",f).style("fill","#0a0").on("mouseenter",(function(){d3.select(this).style("opacity",.3),updateTextPanelBox(E.name,E.value,"o",l,s,u)})).on("mouseleave",(function(){d3.select(this).style("opacity",1),d.filter((function(t){return t.id===E.id})).style("fill","none")})),h.append("svg:text").attr("x",r+4).attr("y",a+p+50).style("font-size","14px").style("fill","brown").text((function(t){return E.name}));var j=o.entries[1].Outputs[1].regions,O=Math.round((100-E.value)/100*e);j.forEach((function(t,e){h.append("svg:rect").attr("x",(function(){return t.left=0==e?w:j[e-1].left+Math.round(j[e-1].value/100*O),t.left})).attr("y",(function(){return t.top=a+p,t.top})).attr("width",(function(){return t.width=Math.round(t.value/100*O),t.width})).attr("height",(function(){return t.height=f,t.height})).on("mouseenter",(function(){d3.select(this).style("opacity",.3),d.filter((function(e){return e.id===t.id})).style("fill","green"),updateTextPanelBox(t.name,t.value,"r",l,s,u)})).on("mouseleave",(function(){d3.select(this).style("opacity",1),d.filter((function(e){return e.id===t.id})).style("fill","none")}))}));m=" M "+(y-10)+" "+(a+p)+" L "+y+" "+(a+p+10)+" L "+(y+10)+" "+(a+p)+" Z";return h.append("svg:path").attr("d",m).style("fill","black"),h.append("svg:text").attr("x",r+46).attr("y",a+p+20).style("fill","black").style("font-size","10px").text("Global Nitrogen Output"),h.append("svg:text").attr("x",r+Math.round(E.value/100*e)).attr("y",a+p+50).style("font-size","13px").style("fill","brown").text((function(t){return"Excess Nutrient"})),j}queue().defer(d3.json,"world-50m.json").defer(d3.json,"N1.json").defer(d3.csv,"excessNrev.csv",type).await(ready),d3.select(self.frameElement).style("height",height+"px");