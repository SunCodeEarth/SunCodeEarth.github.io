!function(t,e){"function"==typeof define&&define.amd?define(["leaflet"],e):"object"==typeof modules&&module.exports?module.exports=e(require("leaflet")):e(L)}(0,(function(t){"use strict";t.DomUtil.setTransform||(t.DomUtil.setTransform=function(e,n,i){var o=n||new t.Point(0,0);e.style[t.DomUtil.TRANSFORM]=(t.Browser.ie3d?"translate("+o.x+"px,"+o.y+"px)":"translate3d("+o.x+"px,"+o.y+"px,0)")+(i?" scale("+i+")":"")}),t.CanvasLayer=(t.Layer?t.Layer:t.Class).extend({initialize:function(e){this._map=null,this._canvas=null,this._frame=null,this._delegate=null,t.setOptions(this,e)},delegate:function(t){return this._delegate=t,this},needRedraw:function(){return this._frame||(this._frame=t.Util.requestAnimFrame(this.drawLayer,this)),this},_onLayerDidResize:function(t){this._canvas.width=t.newSize.x,this._canvas.height=t.newSize.y},_onLayerDidMove:function(){var e=this._map.containerPointToLayerPoint([0,0]);t.DomUtil.setPosition(this._canvas,e),this.drawLayer()},getEvents:function(){var e={resize:this._onLayerDidResize,moveend:this._onLayerDidMove};return this._map.options.zoomAnimation&&t.Browser.any3d&&(e.zoomanim=this._animateZoom),e},onAdd:function(e){this._map=e,this._canvas=t.DomUtil.create("canvas","leaflet-layer"),this.tiles={};var n=this._map.getSize();this._canvas.width=n.x,this._canvas.height=n.y;var i=this._map.options.zoomAnimation&&t.Browser.any3d;t.DomUtil.addClass(this._canvas,"leaflet-zoom-"+(i?"animated":"hide")),this.options.pane.appendChild(this._canvas),e.on(this.getEvents(),this);var o=this._delegate||this;o.onLayerDidMount&&o.onLayerDidMount(),this.needRedraw();var a=this;setTimeout((function(){a._onLayerDidMove()}),0)},onRemove:function(t){var e=this._delegate||this;e.onLayerWillUnmount&&e.onLayerWillUnmount(),this.options.pane.removeChild(this._canvas),t.off(this.getEvents(),this),this._canvas=null},addTo:function(t){return t.addLayer(this),this},drawLayer:function(){var t=this._map.getSize(),e=this._map.getBounds(),n=this._map.getZoom(),i=this._map.options.crs.project(this._map.getCenter()),o=this._map.options.crs.project(this._map.containerPointToLatLng(this._map.getSize())),a=this._delegate||this;a.onDrawLayer&&a.onDrawLayer({layer:this,canvas:this._canvas,bounds:e,size:t,zoom:n,center:i,corner:o}),this._frame=null},_setTransform:function(e,n,i){var o=n||new t.Point(0,0);e.style[t.DomUtil.TRANSFORM]=(t.Browser.ie3d?"translate("+o.x+"px,"+o.y+"px)":"translate3d("+o.x+"px,"+o.y+"px,0)")+(i?" scale("+i+")":"")},_animateZoom:function(e){var n=this._map.getZoomScale(e.zoom),i=t.Layer?this._map._latLngToNewLayerPoint(this._map.getBounds().getNorthWest(),e.zoom,e.center):this._map._getCenterOffset(e.center)._multiplyBy(-n).subtract(this._map._getMapPanePos());t.DomUtil.setTransform(this._canvas,i,n)}}),t.canvasLayer=function(e){return new t.CanvasLayer(e)},t.Control.Velocity=t.Control.extend({options:{position:"bottomleft",emptyString:"Unavailable",angleConvention:"bearingCCW",showCardinal:!1,speedUnit:"m/s",directionString:"Direction",speedString:"Speed",onAdd:null,onRemove:null},onAdd:function(e){return this._container=t.DomUtil.create("div","leaflet-control-velocity"),t.DomEvent.disableClickPropagation(this._container),e.on("mousemove",this._onMouseMove,this),this._container.innerHTML=this.options.emptyString,this.options.leafletVelocity.options.onAdd&&this.options.leafletVelocity.options.onAdd(),this._container},onRemove:function(t){t.off("mousemove",this._onMouseMove,this),this.options.leafletVelocity.options.onRemove&&this.options.leafletVelocity.options.onRemove()},vectorToSpeed:function(t,e,n){var i=Math.sqrt(Math.pow(t,2)+Math.pow(e,2));return"k/h"===n?this.meterSec2kilometerHour(i):"kt"===n?this.meterSec2Knots(i):"mph"===n?this.meterSec2milesHour(i):i},vectorToDegrees:function(t,e,n){n.endsWith("CCW")&&(e=e>0?e=-e:Math.abs(e));var i=Math.sqrt(Math.pow(t,2)+Math.pow(e,2)),o=180*Math.atan2(t/i,e/i)/Math.PI+180;return"bearingCW"!==n&&"meteoCCW"!==n||(o+=180)>=360&&(o-=360),o},degreesToCardinalDirection:function(t){var e="";return t>=0&&t<11.25||t>=348.75?e="N":t>=11.25&&t<33.75?e="NNW":t>=33.75&&t<56.25?e="NW":t>=56.25&&t<78.75?e="WNW":t>=78.25&&t<101.25?e="W":t>=101.25&&t<123.75?e="WSW":t>=123.75&&t<146.25?e="SW":t>=146.25&&t<168.75?e="SSW":t>=168.75&&t<191.25?e="S":t>=191.25&&t<213.75?e="SSE":t>=213.75&&t<236.25?e="SE":t>=236.25&&t<258.75?e="ESE":t>=258.75&&t<281.25?e="E":t>=281.25&&t<303.75?e="ENE":t>=303.75&&t<326.25?e="NE":t>=326.25&&t<348.75&&(e="NNE"),e},meterSec2Knots:function(t){return t/.514},meterSec2kilometerHour:function(t){return 3.6*t},meterSec2milesHour:function(t){return 2.23694*t},_onMouseMove:function(e){var n=this,i=this.options.leafletVelocity._map.containerPointToLatLng(t.point(e.containerPoint.x,e.containerPoint.y)),o=this.options.leafletVelocity._windy.interpolatePoint(i.lng,i.lat),a="";if(o&&!isNaN(o[0])&&!isNaN(o[1])&&o[2]){var r=n.vectorToDegrees(o[0],o[1],this.options.angleConvention),s=this.options.showCardinal?" (".concat(n.degreesToCardinalDirection(r),") "):"";a="<strong> ".concat(this.options.velocityType," ").concat(this.options.directionString,": </strong> ").concat(r.toFixed(2),"Â°").concat(s,", <strong> ").concat(this.options.velocityType," ").concat(this.options.speedString,": </strong> ").concat(n.vectorToSpeed(o[0],o[1],this.options.speedUnit).toFixed(2)," ").concat(this.options.speedUnit)}else a=this.options.emptyString;n._container.innerHTML=a}}),t.Map.mergeOptions({positionControl:!1}),t.Map.addInitHook((function(){this.options.positionControl&&(this.positionControl=new t.Control.MousePosition,this.addControl(this.positionControl))})),t.control.velocity=function(e){return new t.Control.Velocity(e)},t.VelocityLayer=(t.Layer?t.Layer:t.Class).extend({options:{displayValues:!0,displayOptions:{velocityType:"Velocity",position:"bottomleft",emptyString:"No velocity data"},maxVelocity:10,colorScale:null,data:null},_map:null,_canvasLayer:null,_windy:null,_context:null,_timer:0,_mouseControl:null,initialize:function(e){t.setOptions(this,e)},onAdd:function(e){this._paneName=this.options.paneName||"overlayPane";var n=e._panes.overlayPane;e.getPane&&((n=e.getPane(this._paneName))||(n=e.createPane(this._paneName))),this._canvasLayer=t.canvasLayer({pane:n}).delegate(this),this._canvasLayer.addTo(e),this._map=e},onRemove:function(t){this._destroyWind()},setData:function(t){this.options.data=t,this._windy&&(this._windy.setData(t),this._clearAndRestart()),this.fire("load")},setOpacity:function(t){this._canvasLayer.setOpacity(t)},setOptions:function(t){this.options=Object.assign(this.options,t),t.hasOwnProperty("displayOptions")&&(this.options.displayOptions=Object.assign(this.options.displayOptions,t.displayOptions),this._initMouseHandler(!0)),t.hasOwnProperty("data")&&(this.options.data=t.data),this._windy&&(this._windy.setOptions(t),t.hasOwnProperty("data")&&this._windy.setData(t.data),this._clearAndRestart()),this.fire("load")},onDrawLayer:function(t,e){var n=this;this._windy?this.options.data&&(this._timer&&clearTimeout(n._timer),this._timer=setTimeout((function(){n._startWindy()}),750)):this._initWindy(this)},_startWindy:function(){var t=this._map.getBounds(),e=this._map.getSize();this._windy.start([[0,0],[e.x,e.y]],e.x,e.y,[[t._southWest.lng,t._southWest.lat],[t._northEast.lng,t._northEast.lat]])},_initWindy:function(t){var n=Object.assign({canvas:t._canvasLayer._canvas,map:this._map},t.options);this._windy=new e(n),this._context=this._canvasLayer._canvas.getContext("2d"),this._canvasLayer._canvas.classList.add("velocity-overlay"),this.onDrawLayer(),this._map.on("dragstart",t._windy.stop),this._map.on("dragend",t._clearAndRestart),this._map.on("zoomstart",t._windy.stop),this._map.on("zoomend",t._clearAndRestart),this._map.on("resize",t._clearWind),this._initMouseHandler(!1)},_initMouseHandler:function(e){if(e&&(this._map.removeControl(this._mouseControl),this._mouseControl=!1),!this._mouseControl&&this.options.displayValues){var n=this.options.displayOptions||{};n.leafletVelocity=this,this._mouseControl=t.control.velocity(n).addTo(this._map)}},_clearAndRestart:function(){this._context&&this._context.clearRect(0,0,3e3,3e3),this._windy&&this._startWindy()},_clearWind:function(){this._windy&&this._windy.stop(),this._context&&this._context.clearRect(0,0,3e3,3e3)},_destroyWind:function(){this._timer&&clearTimeout(this._timer),this._windy&&this._windy.stop(),this._context&&this._context.clearRect(0,0,3e3,3e3),this._mouseControl&&this._map.removeControl(this._mouseControl),this._mouseControl=null,this._windy=null,this._map.removeLayer(this._canvasLayer)}}),t.velocityLayer=function(e){return new t.VelocityLayer(e)};var e=function(e){var n,i,o,a,r,s,l,h,c,d,p=e.minVelocity||0,u=e.maxVelocity||10,m=(e.velocityScale||.005)*(Math.pow(window.devicePixelRatio,1/3)||1),y=e.particleAge||90,f=e.lineWidth||1,_=e.particleMultiplier||1/300,v=Math.pow(window.devicePixelRatio,1/3)||1.6,g=e.frameRate||15,w=1e3/g,M=.97,x=e.colorScale||["rgb(36,104, 180)","rgb(60,157, 194)","rgb(128,205,193 )","rgb(151,218,168 )","rgb(198,231,181)","rgb(238,247,217)","rgb(255,238,159)","rgb(252,217,125)","rgb(255,182,100)","rgb(252,150,75)","rgb(250,112,52)","rgb(245,64,32)","rgb(237,45,28)","rgb(220,24,32)","rgb(180,0,35)"],L=[NaN,NaN,null],C=e.data,P=function(t,e,n,i,o,a){var r=1-t,s=1-e,l=r*s,h=t*s,c=r*e,d=t*e,p=n[0]*l+i[0]*h+o[0]*c+a[0]*d,u=n[1]*l+i[1]*h+o[1]*c+a[1]*d;return[p,u,Math.sqrt(p*p+u*u)]},S=function(t){var e=null,n=null;return t.forEach((function(t){switch(t.header.parameterCategory+","+t.header.parameterNumber){case"1,2":case"2,2":e=t;break;case"1,3":case"2,3":n=t;break;default:t}})),function(t,e){var n=t.data,i=e.data;return{header:t.header,data:function(t){return[n[t],i[t]]},interpolate:P}}(e,n)},b=function(t,e){if(!i)return null;var o,h=D(t-a,360)/s,c=(r-e)/l,d=Math.floor(h),p=d+1,u=Math.floor(c),m=u+1;if(o=i[u]){var y=o[d],f=o[p];if(T(y)&&T(f)&&(o=i[m])){var _=o[d],v=o[p];if(T(_)&&T(v))return n.interpolate(h-d,c-u,y,f,_,v)}}return null},T=function(t){return null!=t},D=function(t,e){return t-e*Math.floor(t/e)},O=function(t,e,n,i,o,a,r){var s=r[0]*a,l=r[1]*a,h=W(t,e,n,i,o);return r[0]=h[0]*s+h[2]*l,r[1]=h[1]*s+h[3]*l,r},W=function(t,e,n,i,o){var a=2*Math.PI,r=e<0?5:-5,s=n<0?5:-5,l=z(n,e+r),h=z(n+s,e),c=Math.cos(n/360*a);return[(l[0]-i)/r/c,(l[1]-o)/r/c,(h[0]-i)/s,(h[1]-o)/s]},R=function(t,e,n){function i(e,n){var i=t[Math.round(e)];return i&&i[Math.round(n)]||L}i.release=function(){t=[]},i.randomize=function(t){var n,o,a=0;do{n=Math.round(Math.floor(Math.random()*e.width)+e.x),o=Math.round(Math.floor(Math.random()*e.height)+e.y)}while(null===i(n,o)[2]&&a++<30);return t.x=n,t.y=o,t},n(e,i)},N=function(t){return t/180*Math.PI},A=function(n,i,o){var a=e.map.containerPointToLatLng(t.point(n,i));return[a.lng,a.lat]},z=function(n,i,o){var a=e.map.latLngToContainerPoint(t.latLng(n,i));return[a.x,a.y]},V=function(t,n){var i,o,a=(i=p,o=u,x.indexFor=function(t){return Math.max(0,Math.min(x.length-1,Math.round((t-i)/(o-i)*(x.length-1))))},x),r=a.map((function(){return[]})),s=Math.round(t.width*t.height*_);/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)&&(s*=v);for(var l="rgba(0, 0, 0, ".concat(M,")"),h=[],c=0;c<s;c++)h.push(n.randomize({age:Math.floor(Math.random()*y)+0}));var m=e.canvas.getContext("2d");m.lineWidth=f,m.fillStyle=l,m.globalAlpha=.6;var g=Date.now();!function e(){d=requestAnimationFrame(e);var i=Date.now(),o=i-g;o>w&&(g=i-o%w,r.forEach((function(t){t.length=0})),h.forEach((function(t){t.age>y&&(n.randomize(t).age=0);var e=t.x,i=t.y,o=n(e,i),s=o[2];if(null===s)t.age=y;else{var l=e+o[0],h=i+o[1];null!==n(l,h)[2]?(t.xt=l,t.yt=h,r[a.indexFor(s)].push(t)):(t.x=l,t.y=h)}t.age+=1})),m.globalCompositeOperation="destination-in",m.fillRect(t.x,t.y,t.width,t.height),m.globalCompositeOperation="lighter",m.globalAlpha=0===M?0:.9*M,r.forEach((function(t,e){t.length>0&&(m.beginPath(),m.strokeStyle=a[e],t.forEach((function(t){m.moveTo(t.x,t.y),m.lineTo(t.xt,t.yt),t.x=t.xt,t.y=t.yt})),m.stroke())})))}()},E=function(){U.field&&U.field.release(),d&&cancelAnimationFrame(d)},U={params:e,start:function(t,e,d,p){var u={south:N(p[0][1]),north:N(p[1][1]),east:N(p[1][0]),west:N(p[0][0]),width:e,height:d};E(),function(t,e){t.length;var d=(n=S(t)).header;if(d.hasOwnProperty("gridDefinitionTemplate")&&d.gridDefinitionTemplate,a=d.lo1,r=d.la1,s=d.dx,l=d.dy,h=d.nx,c=d.ny,d.hasOwnProperty("scanMode")){var p=d.scanMode.toString(2),u=(p=("0"+p).slice(-8)).split("").map(Number).map(Boolean);u[0]&&(s=-s),u[1]&&(l=-l),u[2],u[3],u[4],u[5],u[6],u[7]}(o=new Date(d.refTime)).setHours(o.getHours()+d.forecastTime),i=[];for(var m=0,y=Math.floor(h*s)>=360,f=0;f<c;f++){for(var _=[],v=0;v<h;v++,m++)_[v]=n.data(m);y&&_.push(_[0]),i[f]=_}e({date:o,interpolate:b})}(C,(function(n){!function(t,e,n,i){var o={},a=(n.south-n.north)*(n.west-n.east),r=m*Math.pow(a,.4),s=[],l=e.x;function h(n){for(var i=[],a=e.y;a<=e.yMax;a+=2){var l=A(n,a);if(l){var h=l[0],c=l[1];if(isFinite(h)){var d=t.interpolate(h,c);d&&(d=O(o,h,c,n,a,r,d),i[a+1]=i[a]=d)}}}s[n+1]=s[n]=i}!function t(){for(var n=Date.now();l<e.width;)if(h(l),l+=2,Date.now()-n>1e3)return void setTimeout(t,25);R(s,e,i)}()}(n,function(t,e,n){var i=t[0],o=t[1],a=Math.round(i[0]),r=Math.max(Math.floor(i[1],0),0);return Math.min(Math.ceil(o[0],e),e-1),{x:a,y:r,xMax:e,yMax:Math.min(Math.ceil(o[1],n),n-1),width:e,height:n}}(t,e,d),u,(function(t,e){U.field=e,V(t,e)}))}))},stop:E,createField:R,interpolatePoint:b,setData:function(t){C=t},setOptions:function(t){t.hasOwnProperty("minVelocity")&&(p=t.minVelocity),t.hasOwnProperty("maxVelocity")&&(u=t.maxVelocity),t.hasOwnProperty("velocityScale")&&(m=(t.velocityScale||.005)*(Math.pow(window.devicePixelRatio,1/3)||1)),t.hasOwnProperty("particleAge")&&(y=t.particleAge),t.hasOwnProperty("lineWidth")&&(f=t.lineWidth),t.hasOwnProperty("particleMultiplier")&&(_=t.particleMultiplier),t.hasOwnProperty("opacity")&&(M=+t.opacity),t.hasOwnProperty("frameRate")&&(g=t.frameRate),w=1e3/g}};return U};return window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)}),t}));
