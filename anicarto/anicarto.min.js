var polyS,polyE,svgPath,d0,d1,width=1e3,height=600,projection=d3.geo.albers().rotate([96,0]).center([-.6,38.7]).scale(1e3),path=d3.geo.path().projection(projection),svg=d3.select("#USAMap").append("svg").attr("width",width).attr("height",height),durationTime=6e3,colInterpolator=d3.scale.linear().domain([1,0]).range(["blue","red"]).interpolate(d3.interpolateRgb),opacityInterpolator=d3.scale.linear().domain([493782,33871648]).range([.5,1]);function ready(t,e,n){var o;t||(polyS=topojson.feature(e,e.objects.USA),polyE=topojson.feature(n,n.objects.USA),polyS.features.forEach((function(t,e){if("MultiPolygon"==t.geometry.type)for(var n=0;n<t.geometry.coordinates.length;n++)o=AlignTwoRingsFast(t.geometry.coordinates[n][0],polyE.features[e].geometry.coordinates[n][0]),t.geometry.coordinates[n][0]=o[0],polyE.features[e].geometry.coordinates[n][0]=o[1];else o=AlignTwoRingsFast(t.geometry.coordinates[0],polyE.features[e].geometry.coordinates[0]),t.geometry.coordinates[0]=o[0],polyE.features[e].geometry.coordinates[0]=o[1]})),svgPath=svg.selectAll("path").data(polyS.features).enter().append("path").attr("d",path),loopMultiPolygons())}function loop(t){(t=t||svgPath).attr("d",d0).transition().duration(durationTime).attr("d",d1).transition().delay(durationTime).attr("d",d0).each("end",loop)}function animatePolygon(t,e,n){t.attr("d",e).style("fill",(function(t,e){return t.properties.Dpct>t.properties.Rpct?"blue":"red"})).transition().duration(durationTime).attr("d",n).transition().delay(durationTime).style("fill",(function(t,e){return colInterpolator(t.properties.Dpct/(t.properties.Dpct+t.properties.Rpct))})).attr("d",e).transition().duration(durationTime).attr("d",n).transition().duration(durationTime).attr("d",e).transition().duration(durationTime).attr("d",n).style("opacity",(function(t,e){return opacityInterpolator(t.properties.POP)})).transition().duration(durationTime).attr("d",e).style("fill",(function(t,e){return t.properties.Dpct>t.properties.Rpct?"blue":"red"})).style("opacity",1)}function loopMultiPolygons(){svgPath.each((function(t,e){animatePolygon(svgPath.filter((function(e){return e.id===t.id})),path(polyS.features[e]),path(polyE.features[e]))})),d3.select("body").transition().duration(6*durationTime).each("end",loopMultiPolygons)}function RingLength(t){for(var e,n,o,r=0,a=t.length,i=0,l=[i],s=t[0];++r<a;)n=(e=t[r])[0]-s[0],o=e[1]-s[1],l.push(i+=Math.sqrt(n*n+o*o)),s=e;return l}function InterpolateRing(t,e,n){var o=[],r=[];t.forEach((function(t,e){o.push(t[0]),r.push(t[1])}));var a=d3.scale.linear().domain(e).range(o).interpolate(d3.interpolateNumber),i=d3.scale.linear().domain(e).range(r).interpolate(d3.interpolateNumber),l=[];return n.forEach((function(t){l.push([a(t),i(t)])})),l}function AlignTwoRingsFast(t,e){if(t.length==e.length)return[t,e];var n,o,r,a,i=0,l=0;i=RingLength(t),l=RingLength(e);var s=1e6;r=i,i.forEach((function(t,e){r[e]=Math.round(t*s/i[i.length-1])})),a=l,l.forEach((function(t,e){a[e]=Math.round(t*s/l[l.length-1])}));var u=a,d=r;r.length>a.length&&(u=r,d=a);var p,g=u.slice(),c=0,h=1e30;return d.forEach((function(t,e){for(;c<g.length;){if(g.length-c<=d.length-e){g[c]=t,c++;break}if(0==(p=Math.abs(t-g[c]))){c++,h=1e30;break}if(p>h){g[c-1]=t,h=1e30;break}h=p,c++}})),r.length>a.length?o=InterpolateRing(e,a,g):n=InterpolateRing(t,r,g),[n||t,o||e]}function UniqueFilter(t,e,n){return n.indexOf(t)===e}function AlignTwoRings(t,e){var n,o,r=0,a=0;r=RingLength(t),a=RingLength(e);var i=1e6;return n=r,r.forEach((function(t,e){n[e]=Math.round(t*i/r[r.length-1])})),o=a,a.forEach((function(t,e){o[e]=Math.round(t*i/a[a.length-1])})),lengthsRatio=n.concat(o).filter(UniqueFilter).sort((function(t,e){return t-e})),[InterpolateRing(t,n,lengthsRatio),InterpolateRing(e,o,lengthsRatio)]}queue().defer(d3.json,"usa.json").defer(d3.json,"usa_2.json").await(ready);